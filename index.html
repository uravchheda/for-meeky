<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Meeky's Quest</title>
<style>
  body { margin: 0; background: black; }
  canvas {
    display: block;
    margin: auto;
    background: #0f111a;
    image-rendering: pixelated;
  }
</style>
</head>
<body>
<canvas id="game" width="900" height="400"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
ctx.imageSmoothingEnabled = false;

// SETTINGS
const gravity = 0.32;
const jumpForce = -11.8;
const groundY = 280;
const obstacleSpeed = 5;
const uravSpeed = 2.2;
const obstacleGap = 1800;
const runFrames = 6;

// IMAGES
const idleImg = new Image(); idleImg.src = "meeksprite.png";
const runImg  = new Image(); runImg.src  = "meekrunning.png";
const jumpImg = new Image(); jumpImg.src = "meekjumpsprite.png";
const uravImg = new Image(); uravImg.src = "uravsprite.png";
const autoImg = new Image(); autoImg.src = "autorikshaw.png";
const bgImg   = new Image(); bgImg.src   = "citybg.png";
const dosaImg = new Image(); dosaImg.src = "blrdosa.png";

const kissImgs = ["kissy1.png","kissy2.png","kissy3.png"].map(src => {
  const i = new Image(); i.src = src; return i;
});

// PLAYER
const player = { x: 100, y: groundY, w: 64, h: 96, vy: 0, onGround: true };

// URAV
const urav = { x: 1400, y: groundY, active: false };

// GAME STATE
let obstacles = [];
let frame = 0, frameTimer = 0;
let state = "landing";
let distance = 0;
let fadeAlpha = 0;
let kissFrame = 0, kissTimer = 0;

// BG
let bgX = 0;

// DIALOGUE
const dialogue = [
  { speaker: "urav", text: "Meeky, what do you want to do for dinner?" },
  { speaker: "meeky", text: "Let's go to Bangalore Dosa!" },
  { speaker: "urav", text: "Okay baby. But make sure you reach in time!" },
  { speaker: "meeky", text: "My gut feeling says I won't make it..." },
  { speaker: "meeky", text: "But my JATT FEELING says I will!!!" },
  { speaker: "system", text: "Press SPACE to start" }
];
let dialogueIndex = 0;
let charIndex = 0;
let typeTimer = 0;
const typeSpeed = 4;
let blinkTimer = 0;

// LANDING FADE
let landingFade = 0;

// WIN TEXT LOGIC
let winStage = 0;
let winChar = 0;
let winTimer = 0;
let winPause = 0;

const winTexts = [
  "You made it ❤️",
  "Will you be my Valentine?",
  "pls?"
];

// INPUT
document.addEventListener("keydown", e => {
  if (e.code === "Space") {

    if (state === "landing") {
      state = "landingFade";
      return;
    }

    if (state === "intro") {
      const full = dialogue[dialogueIndex].text;
      if (charIndex < full.length) {
        charIndex = full.length;
      } else {
        dialogueIndex++;
        charIndex = 0;
        typeTimer = 0;
        blinkTimer = 0;
        if (dialogueIndex >= dialogue.length) state = "playing";
      }
      return;
    }

    if (player.onGround && state === "playing") {
      player.vy = jumpForce;
      player.onGround = false;
    }
  }
});

// OBSTACLES
function spawnObstacle() {
  if (state !== "playing" || urav.active) return;
  obstacles.push({
    x: canvas.width,
    y: groundY + player.h - 64,
    w: 110,
    h: 64
  });
}
setInterval(spawnObstacle, obstacleGap);

// LOOP
function loop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // BG
  if (bgImg.complete && state === "playing") {
    bgX -= 0.6;
    if (bgX <= -canvas.width) bgX = 0;
    ctx.drawImage(bgImg, bgX, 0, canvas.width, canvas.height);
    ctx.drawImage(bgImg, bgX + canvas.width, 0, canvas.width, canvas.height);
  } else {
    ctx.fillStyle = "#0f111a";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  // LANDING
  if (state === "landing" || state === "landingFade") {
    ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
    ctx.drawImage(jumpImg, 418, 140, 96, 144);

    ctx.fillStyle = "white";
    ctx.font = "bold 42px monospace";
    ctx.textAlign = "center";
    ctx.fillText("MEEKY'S QUEST", canvas.width/2, 80);

    blinkTimer++;
    if (Math.floor(blinkTimer/30)%2===0) {
      ctx.font = "20px monospace";
      ctx.fillText("Press SPACE to begin", canvas.width/2, 360);
    }

    if (state === "landingFade") {
      landingFade += 0.02;
      ctx.fillStyle = `rgba(0,0,0,${landingFade})`;
      ctx.fillRect(0,0,canvas.width,canvas.height);
      if (landingFade >= 1) state = "intro";
    }

    requestAnimationFrame(loop);
    return;
  }

  // GROUND
  ctx.fillStyle = "#222";
  ctx.fillRect(0, groundY + player.h - 8, canvas.width, 4);

  // INTRO
  if (state === "intro") {
    const introW = 96, introH = 144;

    ctx.drawImage(idleImg, 270, groundY - 48, introW, introH);
    ctx.drawImage(uravImg, 460, groundY - 48, introW, introH);

    const line = dialogue[dialogueIndex];
    ctx.fillStyle = "rgba(0,0,0,0.7)";
    ctx.fillRect(100, 40, 700, 120);

    const full = line.text;
    typeTimer++;
    if (typeTimer % typeSpeed === 0 && charIndex < full.length) charIndex++;
    const visible = full.substring(0, charIndex);

    if (line.speaker === "meeky") {
      ctx.fillStyle = "#ff6fb7";
      ctx.font = "14px monospace";
      ctx.fillText("MEEKY", 130, 75);
      ctx.font = "18px monospace";
      ctx.fillText(visible, 130, 110);
    }

    else if (line.speaker === "urav") {
      ctx.fillStyle = "#4aa3ff";
      ctx.font = "14px monospace";
      ctx.textAlign = "right";
      ctx.fillText("URAV", 770, 75);
      ctx.font = "18px monospace";
      ctx.fillText(visible, 770, 110);
      ctx.textAlign = "left";
    }

    else {
      blinkTimer++;
      if (Math.floor(blinkTimer/30)%2===0) {
        ctx.fillStyle = "#fff";
        ctx.font = "bold 26px monospace";
        ctx.textAlign = "center";
        ctx.fillText(visible, canvas.width/2, 210);
        ctx.textAlign = "left";
      }
    }

    requestAnimationFrame(loop);
    return;
  }

  // GAMEPLAY
  if (state === "playing") {
    player.vy += gravity;
    player.y += player.vy;
    if (player.y >= groundY) {
      player.y = groundY;
      player.vy = 0;
      player.onGround = true;
    }
  }

  if (!player.onGround) ctx.drawImage(jumpImg, player.x, player.y, player.w, player.h);
  else {
    frameTimer++;
    if (frameTimer > 12) { frame++; frameTimer = 0; }
    const fw = runImg.width/runFrames;
    ctx.drawImage(runImg,(frame%runFrames)*fw,0,fw,runImg.height,player.x,player.y,player.w,player.h);
  }

  for (let o of obstacles) {
    if (state === "playing") o.x -= obstacleSpeed;
    ctx.drawImage(autoImg, o.x, o.y, o.w, o.h);
  }

  if (state === "playing") distance += 0.1;

  if (!urav.active && distance > 180) urav.active = true;
  if (urav.active && state === "playing") urav.x -= uravSpeed;
  ctx.drawImage(uravImg, urav.x, urav.y, 64, 96);

  if (state === "playing" && urav.active && player.x + player.w > urav.x) state = "won";

  // WIN
  if (state === "won") {
    fadeAlpha = Math.min(1, fadeAlpha + 0.01);
    ctx.fillStyle = `rgba(0,0,0,${fadeAlpha})`;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    if (fadeAlpha > 0.4) {
      ctx.drawImage(dosaImg, 200, 40, 500, 260);

      kissTimer++;
      if (kissTimer > 20) { kissFrame = (kissFrame + 1) % 3; kissTimer = 0; }
      ctx.drawImage(kissImgs[kissFrame], 350, groundY - 70, 200, 140);

      winTimer++;
      if (winChar < winTexts[winStage].length && winTimer % 8 === 0) {
        winChar++;
      }

      ctx.fillStyle = "white";
      ctx.textAlign = "center";

      if (winStage === 0) {
        ctx.font = "24px monospace";
        ctx.fillText(winTexts[0].substring(0, winChar), canvas.width/2, 350);

        if (winChar >= winTexts[0].length) {
          winPause++;
          if (winPause > 60) { winStage = 1; winChar = 0; winPause = 0; }
        }
      }

      else if (winStage === 1) {
        ctx.font = "24px monospace";
        ctx.fillText(winTexts[1].substring(0, winChar), canvas.width/2, 350);

        if (winChar >= winTexts[1].length) {
          winPause++;
          if (winPause > 60) { winStage = 2; winChar = 0; winPause = 0; }
        }
      }

      else {
        ctx.font = "18px monospace";
        ctx.fillText(winTexts[2].substring(0, winChar), canvas.width/2, 380);
      }

      ctx.textAlign = "left";
    }
  }

  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
